<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />

    <title>launching the netflakes blog</title>
	
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href="stylesheets/all.css?1410311636" rel="stylesheet" type="text/css" />
    <script src="javascripts/all.js?1410311636" type="text/javascript"></script>
	
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Netflakes - Steve Forkin">

  </head>
  <body>

    <div class="wrapper">

      <header>
        <h1><a href="/">Netflakes</a></h1>
		<h4>Ruby is Fun..</h4>
        by <a href="mailto:steve@netflakes.org">Steve Forkin</a>
      </header>

      <section>
        
  <h2><a href="active-resource-token-auth/">active-resource-token-auth</a> <span>Sep 11</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="active-resource-token-auth-and-nginx">Active Resource, Token Auth and Nginx</h2>

<h4 id="active-resource-works-really-nicely-with-rest-api-from-rails">Active Resource works really nicely with Rest Api from Rails</h4>

<p>I am currently building a reasonably large web application that consumes several rest api based data sources. Each of these are integrated into the main application and joined by a company id that is guid based. Each api sits on the inside of the network at the moment but might not future growth. The system will authenticate with each api using random generated tokens. These are added to the request headers as well as the company id to ensure the correct scoping for each api call.</p>

<p>I have a base class for each of the services that requires authentication and here I set the auth token and the company id for each request. </p>

<pre><code>module RestServices
  class ServiceBase &lt; ActiveResource::Base

    cattr_reader :api_token, :company_id
    cattr_accessor :static_headers

    self.static_headers = headers

    def self.headers
      # - override the headers to ensure we always have the request based/current ones
      new_headers = static_headers.clone
      new_headers["Authorization"] = set_token_header
      new_headers["company_id"] = set_company_header
      new_headers
    end  
	
    def self.set_token_header
      "Token token=#{@@api_token}"  
    end  
	
    def self.set_company_header
      @@company_id.to_s
    end  
	
    def self.authorise(token, company_id)
      @@api_token = token
      @@company_id = company_id
      #
      # - raise an appropriate error if we don't have the right credentials!
      check_valid_authentication
    end  
	
    private
    def self.set_credentials?
      check_api_token? &amp;&amp; check_company?
    end
	
	# check_api_token AND check_company - business logic commented out here..
    def self.check_valid_authentication
      # - we should raise an error to be caught at the application level of the credentials have not been set to ensure service calls include a valid token in the header
      raise ApplicationErrors::InvalidCredentialError unless set_credentials? 
    end
  end    
end  
</code></pre>

<p>In each rest api controller you then just need a before filter to ensure the request headers are populated:</p>

<pre><code>prepend_before_filter :require_login
before_filter :enable_service_authenticator
</code></pre>

<p>And the authorise method: How you obtain the token and the company id etc.. is up to your business logic..</p>

<pre><code>def enable_service_authenticator
  Resource.authorise(resource_api_token, current_company.id)
end  
</code></pre>

<p>One issue that I had with nginx is that by default it removes any custom headers that have an underscore in it - took me a while to figure this one out. Here is the (nginx docu on configuring custom headers)[http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers]</p>

<p>After that I was all set with token auth against the rest api resources. The final piece was to add some rescue_from statements into the ApplicationController with relevant responses to gracefully handle connection issues.._</p>

<pre><code># - Catch all situations where we called for a record that does not exist
rescue_from ActiveResource::ResourceNotFound, :with =&gt; :rescue_not_found

# - Catch all situations where the services api-s are down
rescue_from Errno::ECONNREFUSED, :with =&gt; :rescue_service_unavailable
</code></pre>

<p>Enjoy!</p>


  <h2><a href="capistranodeployprocess/">CapistranoDeployProcess</a> <span>Sep  9</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="capistrano-automatic-deployment-to-staging-and-prod">Capistrano, Automatic Deployment to Staging and Prod</h2>

<h4 id="capistrano-is-the-de-facto-ruby-deployment-process-toolbox">Capistrano is the de-facto ruby deployment process toolbox.</h4>

<p>I use RVM extensively for all my ruby and rails projects and also use it in my staging and deployment environments. Capistrano works well with it and here is a set of samples of how I do my deployments. This sample is from a rest-api that is part of one of my recent projects. The project name is changed to "sample".</p>

<p>All the basic info can be found on the <a href="http://capistranorb.com">Capistrano</a> website. </p>

<p>First up my CAPFILE: (the rvm1/capistrano3 gem works really well for dealing with RVM deployments)</p>

<pre><code> 1 # Load DSL and Setup Up Stages
 2 require 'capistrano/setup'
 3 
 4 # Includes default deployment tasks
 5 require 'capistrano/deploy'
 6 
 7 # Includes tasks from other gems included in your Gemfile
 8 #
 9 # For documentation on these, see for example:
10 #...
16 #
17 require 'rvm1/capistrano3'
18 require 'capistrano3/unicorn'
19 #...
27 # Loads custom tasks from `lib/capistrano/tasks' if you have any defined.
28 Dir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }
</code></pre>

<p>I use RVM and setting the correct ruby and gemset worked really well..</p>

<p>The next set of code snippets are all from my config/deploy.rb</p>

<pre><code># - Configuration settings for the deployment process
#
set :rvm_ruby_version, 'ruby-2.1.1@sampleapi'
set :rvm1_ruby_version, 'ruby-2.1.1@sampleapi'
#
set :default_env, { rvm_bin_path: '~/.rvm/bin' }
SSHKit.config.command_map[:rake] = "#{fetch(:default_env)[:rvm_bin_path]}/rvm ruby-#{fetch(:rvm_ruby_version)} do bundle exec rake"
#
# config valid only for Capistrano 3.1
lock '3.2.1'
#
set :application, 'sampleapi'
#
#default_run_options[:pty] = true
#
set :repo_url, 'git@bitbucket.org:sample-user/sampleapi.git'
#
</code></pre>

<p>Remote cache is much faster..</p>

<pre><code># Deply via remote cache
set :deploy_via, :remote_cache
#
# Default branch is :master
set :branch, "master"
# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call
</code></pre>

<p>Set the deploy folder</p>

<pre><code># Default deploy_to directory is /var/www/my_app
set :deploy_to, '/opt/www/sampleapi'
</code></pre>

<p>We use GIT</p>

<pre><code># Default value for :scm is :git
set :scm, :git


# Default value for :format is :pretty
set :format, :pretty
</code></pre>

<p>Turn on debug log level if you have a failed deploy to figure out what went wrong</p>

<pre><code># Default value for :log_level is :debug
#set :log_level, :debug
set :log_level, :info
#
# SSH connections made to non standard port
set :ssh_options, {
  config: false,
}
#
</code></pre>

<p>This ensures any RVM updates and gem updates are always considered in each deploy step</p>

<pre><code>before 'deploy', 'rvm1:install:rvm'
before 'deploy', 'rvm1:install:ruby'
before 'deploy', 'rvm1:install:gems'
#
# - These two lines are for when  Pubkey Auth is not enabled - i.e. prompts for the password
#set :password, ask('Server password', nil)
#server 'sample.cloudapp.net', user: 'deployer', port: 2122, password: fetch(:password), roles: %w{web app db}
#
</code></pre>

<p>We use public key auth for SSH - the two lines above allow you to use password auth instead</p>

<pre><code># - This is for when Pubkey Auth is enabled..
server 'samplecloudapp.net', user: 'deployer', port: 2122, roles: %w{web app db}
#
# Stages in our case is just set to production
set :stages, ["production"]
#
# Default value for :pty is false
# set :pty, true
set :pty, true
</code></pre>

<p>Here we make sure the yml config are not removed with each deploy - since they are symlinked from a shared folder</p>

<pre><code># Default value for :linked_files is []
# This means that the database.yml and redis.yml files are not get blatted with each new deploy!
#
set :linked_files, %w{config/database.yml config/redis.yml}
#
# Default value for linked_dirs is []
set :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}
# Default value for keep_releases is 5
set :keep_releases, 5
# touch assets etc - to ensure they are refreshed with each deploy during development
#set :normalize_asset_timestamps, %{public/images public/javascripts public/stylesheets}
</code></pre>

<p>This api uses unicorn as the webserver..</p>

<pre><code># set some unicorn values
set :unicorn_pid, '/opt/www/sampleapi/shared/pids/unicorn.pid'
#
set :unicorn_config_path, '/opt/www/sampleapi/current/config/unicorn.rb'
#
set :environment, "production"
#
</code></pre>

<p>This is the final set of customised steps to link our configurations files, migrate the DB if required and 
recompile all the assets with each deploy.</p>

<pre><code>namespace :deploy do
  desc 'assets and db migration'
  task :dbmigrate do
    on roles(:app) do
      execute "cd #{fetch(:deploy_to)}/current/"
      execute "cd #{fetch(:deploy_to)}/shared/config"
      within "#{fetch(:deploy_to)}/shared/config/" do
        execute "ln -sfn #{fetch(:deploy_to)}/shared/config/database.yml #{fetch(:deploy_to)}/current/config/database.yml"
        execute "ln -sfn #{fetch(:deploy_to)}/shared/config/redis.yml #{fetch(:deploy_to)}/current/config/redis.yml"
      end
      execute "cd #{fetch(:deploy_to)}/current/" # just so we are in the app folder
      within "#{fetch(:deploy_to)}/current/" do
        with RAILS_ENV: fetch(:environment) do
          execute :rake, "db:migrate"
          execute :rake, "assets:precompile"
        end
      end  
    end
  end  
</code></pre>

<p>And finally restart UNICORN..</p>

<pre><code>  desc 'restart unicorn'
  task :restart do
    invoke 'unicorn:restart'
  end  

  after :publishing, :dbmigrate
  after :dbmigrate, :restart

end
</code></pre>

<p>With this you should have a working automatic deployment..</p>

  <h2><a href="jenkinstobuildruby/">JenkinsToBuildRuby</a> <span>Sep  9</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="jenkins-continuous-integration-server-and-ruby">Jenkins, Continuous Integration Server and Ruby</h2>

<h4 id="jenkins-is-really-easy-to-install-on-a-vps-and-the-configuration-of-building-ruby-is-a-snap">Jenkins is really easy to install on a vps and the configuration of building ruby is a snap</h4>

<p>I have recently started my own business, building a Web Application with Ruby and Rails. I use <a href="ttp://capistranorb.com/">Capistrano</a> for automated build deployment. Since I develop using a TDD approach, I was keen to have a continuous deployment process to the cloud up and running from the start.</p>

<p>In my last job I used Windows Azure extensively and for comfort reasons decided to fire up a few Ubuntu virtual machines for a continuous build and deployment process. I have three virtual machines, one running <a href="http://jenkins-ci.org/">Jenkins</a> as a build server, one application server and one database server. I use <a href="https://bitbucket.org/">Bitbucket</a> for Git source control. </p>

<p>The basic flow - each time code is deployed to the master branch in Git, this triggers a build in Jenkins and in turn all unit and integration tests are run. On succes a second project in Jenkins does a full capistrano based automatic deployment to the Azure environment. This gives me a daily fresh build of all the work done.</p>

<p>I don't check in yml configuration files such as the database.yml and other such files into source control. They are just symlinked to shared configuration folders both in my local dev and in the deployment environments. For the Jenkins build process a simple shell script generates these files on the fly during the build process. </p>

<p>The jenkins configuration also allows you to </p>

<pre><code>	Build when a change is pushed to Bitbucket
	Run the build in a RVM-managed environment (simple add your ruby/gemset here!)
</code></pre>

<p>The shell script below is the meat of the build (sensitive bits overwritten with ##..)</p>

<pre><code>#!/bin/bash -x

unlink config/database.yml
unlink config/redis.yml
unlink config/services.yml

export RAILS_ENV=test

bundle install

read -d '' database_yml &lt;&lt;"EOF"  
login: &amp;login  
  adapter: postgresql
  encoding: unicode
  username: #########
  password: #########
  host: #########

test: &amp;test  
  database: ###web_test
  &lt;&lt;: *login
EOF

echo "$database_yml" &gt; config/database.yml  

read -d '' redis_yml &lt;&lt;"EOF"
default:
  host: localhost
  port: 6379
test:
  db: 1
production:
  db: 2
EOF

echo "$redis_yml" &gt; config/redis.yml

read -d '' services_yml &lt;&lt;"EOF"

services: &amp;services
  mail_api_baseurl: http://localhost:3001
  mail_api_current_version: api/v1
  ###_api_baseurl: http://localhost:3002
  ###_api_current_version: api/v1
  #####_api_baseurl: http://localhost:3003
  #####_api_current_version: api/v1

development:
  &lt;&lt;: *services

test:
  &lt;&lt;: *services

production:
  &lt;&lt;: *services

EOF

echo "$services_yml" &gt; config/services.yml


rake db:create db:test:prepare  

bundle exec rspec spec/models

bundle exec rspec spec/fast

bundle exec rspec spec/controllers
</code></pre>

<p>The second project that does the actual deployment from Jenkins has these two simple shell scripts that handle the Capistrano deployment - nice and simple and it works:</p>

<p>One to do the actual prep work..</p>

<pre><code>#!/bin/bash -x
export RAILS_ENV=production
bundle install
</code></pre>

<p>And the second to do the deploy..</p>

<pre><code>eval `ssh-agent`
echo $SSH_AGENT_PID &gt; agent.pid
ssh-add
bundle exec cap production deploy
</code></pre>

<p>Apart from the actual Capistrano deploy script that is pretty much it!</p>

<p>Enjoy.</p>


  <h2><a href="tdd-with-nsubstitute/">tdd with nsubstitute</a> <span>May  5</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="testing-each-step-in-isolation-with-nsubstitute">Testing each step in isolation with NSubstitute</h2>

<h4 id="nsubstitute-is-a-great-way-to-abstract-each-dependency-away-from-the-method-being-tested">NSubstitute is a great way to abstract each dependency away from the method being tested</h4>

<p>I use <a href="https://github.com/xunit/xunit">Xunit</a> for unit testing each of layer of abstraction during development. I recently started
to work with a framework called <a href="http://nancyfx.org/">Nancy</a> - the guys who developed this framework call it the - super-duper-happy-path - of web development. Am beginning to feel the same way as I work my way through all the docu and work with the framework it is really cool. One of the things I really enjoy is the testability. Nancy was developed using TDD and it makes
mocking and testing each individual piece of the pie super simple.</p>

<p><a href="http://nsubstitute.github.io/">NSubstitute</a> is a really nice way of doing all the required mocks to ensure you are testing only the actual method/process you want to test!</p>

<p>This is a sample of testing a module in Nancy. Modules here are what Controllers are for traditional MVC. Nancy tries to imitate the
small scale framework called <a href="http://www.sinatrarb.com/">Sinatra</a> in the world of Ruby. I have used this too - its great to get
small apps and webservices up and running really quickly with a small amount of code. It just gets out of your way. This is the
way of Nancy too, and yet its very flexible in terms of stuff you can add on as and when needed.</p>

<p>Here I am testing a route that adds a new user - during this process the UserService and the UserRepository objects are both required
and yet they are tested separately in other unit tests. Providing you have got proper Interfaces for your Service and Repository layers, NSubstitute will just abstract them away for you and allow you to quickly pre-set what results will be returned from the methods of the mocked objects - cool and really easy.</p>

<pre><code>[Fact]
public void TestAddingAnewUser_whereUserDoesNotExist_WithHtmlForm() 
{
    var testUser = CreateTestUser();
	
	/// mock the User Repository and all methods required for this test
    IUserRepository userRepo = Substitute.For&lt;IUserRepository&gt;();
    userRepo.Add(Arg.Any&lt;User&gt;()).Returns(true);
    userRepo.IsUnique(testUser.UserIdentifier).Returns(true);			
	
	// mock the User Service and the methods required for this test
    IUserService userService = Substitute.For&lt;IUserService&gt;();
    userService.CreateUser(Arg.Any&lt;User&gt;()).Returns(testUser.UserId);
    
    TestBrowser = BrowserSetup(userRepo, userService);
	
    // run the actual test
    var response = TestBrowser.Post(UsersUri, (with) =&gt;
    {
        with.Header("Accept", TextHtml);
        with.HttpRequest();
        with.FormValue("UserIdentifier", testUser.UserIdentifier);
        with.FormValue("UserName", testUser.UserName);
        with.FormValue("PrescriberNumber", testUser.PrescriberNumber.ToString());
        with.FormValue("Fax", testUser.Fax);
        with.FormValue("Mobile",testUser.Mobile );
        with.FormValue("Telephone", testUser.Telephone);
        with.FormValue("Address1", testUser.Address1);
        with.FormValue("Address2", testUser.Address2);
        with.FormValue("Suburb", testUser.Suburb);
        with.FormValue("State", testUser.State);
        with.FormValue("Postcode", testUser.Postcode);
        with.FormValue("PostalSame", testUser.PostalSame.ToString());
        with.FormValue("PostalAddress1", testUser.PostalAddress1);
        with.FormValue("PostalAddress2", testUser.PostalAddress2);
        with.FormValue("PostalSuburb", testUser.PostalSuburb);
        with.FormValue("PostalPostcode", testUser.PostalPostcode);
        with.FormValue("PostalState", testUser.PostalState);
        with.FormValue("LastUpdated", testUser.LastUpdated.ToShortDateString());
    });
    // and check for a proper result
    response.ShouldHaveRedirectedTo(UsersUri + testUser.UserId);
}
</code></pre>

<p>As I work my way through building an API based app - I will add more updates on this.</p>

  <h2><a href="building-with-albacore/">building c# with albacore</a> <span>May  3</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="albacore-fun-and-easy-build-tool-for-net">Albacore, fun and easy build tool for .NET</h2>

<h4 id="xml-ms-build-and-the-likes-are-no-fun-whereas-albacores-ruby-dsl-makes-for-a-great-build-tool-for-net-projects">xml, ms build and the likes are no fun whereas Albacore's ruby dsl makes for a great build tool for .NET projects</h4>

<p>Over the last 2 years I have been doing more work with Ruby, Rails when it comes to building web apps and also building some
infrastructure automation in my day time job using <a href="http://www.getchef.com/chef/">chef</a>. Since I am not a huge fan of XML and
avoid it when possible, I came accross <a href="http://albacorebuild.net/">Albacore</a> - which is a suite of <a href="http://rake.rubyforge.org/">Rake</a>
tasks with a nice DSL to very quickly put together build scripts for .NET projects. Even if you are not a seasoned Ruby developer
the amount of Ruby required to complete the build related tasks for .NET in Albacore is learned really quickly.</p>

<p>The basic requirement to get started with Albacore is to install Ruby. Windows support for Ruby is getting better. Most of my usual
Ruby dev work is done in OSX and I use RVM to be able to have project based versioning on the Ruby side, you can't go passed this one.. There is a somewhat more limited third party tool called <a href="https://github.com/vertiginous/pik">Pik</a> which does all you need to get started with building .NET with Ruby.</p>

<p>Create a <code>Gemfile</code> in the root of the project like this sample here:</p>

<pre><code> source 'https://rubygems.org'

 gem 'albacore', '0.3.5'
 gem 'rubyzip', '0.9.9'
</code></pre>

<p>Run <code>bundle</code> or <code>bundle install</code> to get the relevant gems installed. I had some issues with newer versions of the Albacore gem.</p>

<p>Then create a <code>Rakefile</code> in the root of your project which has all the build, test and publish related steps in it.</p>

<p>At the start of the build script - you will typically configure the environment related stuff:</p>

<pre><code>#
ENVIRONMENT = "Debug"
#ENVIRONMENT = "Release"
#
BUILD_VERSION = 1001
BUILD_DIR = "build"
SOLUTION_NAME = "ManageAzure"
PUBLISH_BASE = "c:/publish"
PUBLISH_DIR = "#{PUBLISH_BASE}/#{SOLUTION_NAME}"
SOLUTION = "#{SOLUTION_NAME}.sln"
PROJECT_DIR = "ManageAzure"
CONFIGURATION_OPT = "Debug"
#CONFIGURATION_OPT = "Release"
</code></pre>

<p>Since I also use xunit for my unit tests in C# projects - you will need to configure the runner..</p>

<pre><code>#
XUNIT_CONSOLE = "./Packages/xunit.1.9.2.runner/xunit.console.clr4.exe"
UNIT_TEST_PROJECT = "ManageAzureTests"
UNIT_TEST_ASSEMBLY = "./#{UNIT_TEST_PROJECT}/bin/#{ENVIRONMENT}/#{UNIT_TEST_PROJECT}.dll"
</code></pre>

<p>Then the actual <code>build</code> and <code>test</code> steps are really simple Ruby code blocks:</p>

<pre><code>#
desc "Run All Unit Tests"
xunit :unittest do |xunit|
    xunit.command = XUNIT_CONSOLE
    xunit.assembly = UNIT_TEST_ASSEMBLY
end
#
desc "Run the build step - in this case clean and build"
msbuild :build do |cmd|
	cmd.solution = "#{SOLUTION}"
	cmd.targets = [:Clean, :Build]
	cmd.properties = {:Configuration =&gt; CONFIGURATION_OPT}
end
</code></pre>

<p>Finally you can chain steps into rake tasks to make things easier:</p>

<pre><code>task :test =&gt; [:build, :unittest] do
end
</code></pre>

<p>Here is a <a href="https://github.com/netflakes/AzureManagement/blob/master/RakeFile">Sample</a> build <code>Rakefile</code> for a recent project of mine.</p>

<p>The Albacore <a href="https://github.com/Albacore/albacore/wiki">Wiki</a> has all the detailed information to get started.  When it comes to doing up a build script for .NET - this is so much more fun than fiddling with XML descriptors etc.</p>

<p>Enjoy!</p>

  <h2><a href="working-with-tinyioc/">working with tinyioc</a> <span>May  2</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="inversion-of-control-with-tinyioc">Inversion of Control with TinyIoC</h2>

<h4 id="dependency-injection-is-made-really-simple-with-tinyioc-and-for-smaller-projects">Dependency Injection is made really simple with TinyIoC and for smaller projects</h4>

<p><a href="https://github.com/grumpydev/TinyIoC/wiki">TinyIoC</a> is really easy to use the setup is simplified and it is great to provide
depencies to internal libraries and swap these out for different purposes. In building my Abstraction layer around the new
Azure Management Client library to manage &amp; report on Azure Cloud Services I used <a href="https://github.com/grumpydev/TinyIoC/wiki">TinyIoC</a> to inject the Logging and the configuration as in ability to provide the
Azure subscriptionId and the Base64 Encoded Management certificate. In my case I am reading both of these from the downloaded
PublishSettings files for each subscription.</p>

<p>The library I am working on is <a href="https://github.com/netflakes/AzureManagement/blob/master/ManageAzure/Lib/AzureManagement.cs">here</a>
and here is how the dependencies are injected with TinyIoC:</p>

<p>You have a <code>Bootstrap</code> class where the depencies are <code>registered</code> with the Container. By using the <code>Interface</code> we are effectively
telling the IoC container to fire up a <code>singleton</code> based instance - i.e. the only one ever running in the application.</p>

<pre><code>public static class Bootstrap 
    {
        public static void Register(string settingsFile)
        {
            IMlogger mLogger = new Mlogger();
            IAppConfiguration appConfig = new ApplicationConfiguration(settingsFile);
            TinyIoCContainer.Current.Register&lt;IMlogger&gt;(mLogger);
            TinyIoCContainer.Current.Register&lt;IAppConfiguration&gt;(appConfig);
        }
    }
</code></pre>

<p>Then when the application is started:</p>

<pre><code>static void Main(string[] args)
{
    Bootstrap.Register(AzurePublishSettingsFile);
    var application = TinyIoCContainer.Current.Resolve&lt;AzureManagement&gt;();
</code></pre>

<p>You let the container do the actual dependency resolution and it takes care of building the objects with the right constructor.</p>

<p>In the case of the <code>IAppConfiguration</code> dependency I have an interface that determines what methods the class provides to the outside world - i.e. the two requirements for the Azure Management Client - which needs the <code>SubscriptionId</code> &amp; the <code>Base64EncodedManagementCertificate</code>.</p>

<pre><code>public interface IAppConfiguration 
{
    string SubscriptionId();
    string Base64EncodedManagementCertificate();
}
</code></pre>

<p>This is then implemented in my case as: (remembering the bueauty of DI is that this could then be changed later with any impact on the library that uses the data provided by this object/interface)</p>

<pre><code>public class ApplicationConfiguration : IAppConfiguration
{
    PublishData AzurePublishData { get; set; }
	
    public ApplicationConfiguration(string settingsFile)
    {
        AzurePublishData = ReadAzurePublishSettingsFile(settingsFile);
    }
	
    public string SubscriptionId()
    {
        return AzurePublishData._Profile._Subcription.Id;
    }
	
    public string Base64EncodedManagementCertificate()
    {
        return AzurePublishData._Profile._Subcription.ManagementCertificate;
    }
	
    /// &lt;summary&gt;
    /// Deserialises the Azure Publish Settings File into a tree of objects that hold the Subscription Id and the Base 64 encoded Management Certificate
    /// &lt;/summary&gt;
    /// &lt;param name="settingsPath"&gt;Full path and file name of the Azure Publish Settings File&lt;/param&gt;
    /// &lt;returns&gt;A PublishData object containing the Subscription Id and the Management Certificate&lt;/returns&gt;
    private PublishData ReadAzurePublishSettingsFile(string settingsPath)
    {
        TextReader reader = null;
        try
        {
            XmlSerializer deserializer = new XmlSerializer(typeof(PublishData));
            reader = new StreamReader(@settingsPath);
            object obj = deserializer.Deserialize(reader);
            PublishData XmlData = (PublishData)obj;
            return XmlData;
        }
        catch (InvalidOperationException ioe)
        {
            var message = String.Format("Error Reading the Azure Publish Settings File{0}", ioe);
            throw ioe;
        }
        finally
        {
            reader.Close();
        }
    }
</code></pre>

<p>Following on from this theme - my next step with this library will be implement local storage and reporting processes that will also be injected at startup so that they can be swapped out and also developed independantly of changes made to the library that is providing the data.</p>

<p>More to follow soon.</p>

  <h2><a href="building-net-with-albacore/">building .NET with albacore</a> <span>May  2</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="albacore-fun-and-easy-build-tool-for-net">Albacore, fun and easy build tool for .NET</h2>

<h4 id="xml-ms-build-and-the-likes-are-no-fun-whereas-albacores-ruby-dsl-makes-for-a-great-build-tool-for-net-projects">xml, ms build and the likes are no fun whereas Albacore's ruby dsl makes for a great build tool for .NET projects</h4>

<p>Over the last 2 years I have been doing more work with Ruby, Rails when it comes to building web apps and also building some
infrastructure automation in my day time job using <a href="http://www.getchef.com/chef/">chef</a>. Since I am not a huge fan of XML and
avoid it when possible, I came accross <a href="http://albacorebuild.net/">Albacore</a> - which is a suite of <a href="http://rake.rubyforge.org/">Rake</a>
tasks with a nice DSL to very quickly put together build scripts for .NET projects. Even if you are not a seasoned Ruby developer
the amount of Ruby required to complete the build related tasks for .NET in Albacore is learned really quickly.</p>

<p>The basic requirement to get started with Albacore is to install Ruby. Windows support for Ruby is getting better. Most of my usual
Ruby dev work is done in OSX and I use RVM to be able to have project based versioning on the Ruby side, you can't go passed this one.. There is a somewhat more limited third party tool called <a href="https://github.com/vertiginous/pik">Pik</a> which does all you need to get started with building .NET with Ruby.</p>

<p>Create a <code>Gemfile</code> in the root of the project like this sample here:</p>

<pre><code> source 'https://rubygems.org'

 gem 'albacore', '0.3.5'
 gem 'rubyzip', '0.9.9'
</code></pre>

<p>Run <code>bundle</code> or <code>bundle install</code> to get the relevant gems installed. I had some issues with newer versions of the Albacore gem.</p>

<p>Then create a <code>Rakefile</code> in the root of your project which has all the build, test and publish related steps in it.</p>

<p>At the start of the build script - you will typically configure the environment related stuff:</p>

<pre><code>#
ENVIRONMENT = "Debug"
#ENVIRONMENT = "Release"
#
BUILD_VERSION = 1001
BUILD_DIR = "build"
SOLUTION_NAME = "ManageAzure"
PUBLISH_BASE = "c:/publish"
PUBLISH_DIR = "#{PUBLISH_BASE}/#{SOLUTION_NAME}"
SOLUTION = "#{SOLUTION_NAME}.sln"
PROJECT_DIR = "ManageAzure"
CONFIGURATION_OPT = "Debug"
#CONFIGURATION_OPT = "Release"
</code></pre>

<p>Since I also use xunit for my unit tests in C# projects - you will need to configure the runner..</p>

<pre><code>#
XUNIT_CONSOLE = "./Packages/xunit.1.9.2.runner/xunit.console.clr4.exe"
UNIT_TEST_PROJECT = "ManageAzureTests"
UNIT_TEST_ASSEMBLY = "./#{UNIT_TEST_PROJECT}/bin/#{ENVIRONMENT}/#{UNIT_TEST_PROJECT}.dll"
</code></pre>

<p>Then the actual <code>build</code> and <code>test</code> steps are really simple Ruby code blocks:</p>

<pre><code>#
desc "Run All Unit Tests"
xunit :unittest do |xunit|
    xunit.command = XUNIT_CONSOLE
    xunit.assembly = UNIT_TEST_ASSEMBLY
end
#
desc "Run the build step - in this case clean and build"
msbuild :build do |cmd|
	cmd.solution = "#{SOLUTION}"
	cmd.targets = [:Clean, :Build]
	cmd.properties = {:Configuration =&gt; CONFIGURATION_OPT}
end
</code></pre>

<p>Finally you can chain steps into rake tasks to make things easier:</p>

<pre><code>task :test =&gt; [:build, :unittest] do
end
</code></pre>

<p>Here is a <a href="https://github.com/netflakes/AzureManagement/blob/master/RakeFile">Sample</a> build <code>Rakefile</code> for a recent project of mine.</p>

<p>The Albacore <a href="https://github.com/Albacore/albacore/wiki">Wiki</a> has all the detailed information to get started.  When it comes to doing up a build script for .NET - this is so much more fun than fiddling with XML descriptors etc.</p>

<p>Enjoy!</p>

  <h2><a href="launching-the-netflakes-blog/">launching the netflakes blog</a> <span>May  1</span></h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
  <h2 id="launching-my-new-code-blog-on-github">Launching my new code blog on github</h2>

<h4 id="this-is-my-attempt-to-document-my-journey-whilst-developing-with-using-c-and-some-ruby-and-others">This is my attempt to document my journey whilst developing with using C# and some Ruby and others</h4>

<p>Lately I have been working with the Azure platform a fair bit and with the recent release of the <a href="http://www.bradygaster.com/post/getting-started-with-the-windows-azure-management-libraries">Windows Azure Management Libraries</a>.</p>

<p>Prior to this I have used powershell to interact with the Windows Azure Rest API, but this new set of Client Libraries is so much more fun.</p>

<p>My initial solution is available on my <a href="https://github.com/netflakes/AzureManagement">github.com/netflakes</a> account. Sofar I have a project that gathers stats on the cloud services and virtual machines and can also download sets of RDP files for all or for Cloud services.</p>

<p>Following my passion for TDD I have a set of unittests for each method and this will grow. Logging and configuration is isolated from the main code via DI. There is a command line app that will be able to call each method in the class library. Following on from this I intend to add different output/storage mechanisms also via DI that can be plugged in when needed.</p>

<p>At my work we have a large number of subscriptions and associated services for the many projects we are involved in and this is becoming ever more complex to manage. Automating this is the only way to keep a handle on things.</p>

<p>We also have the need to dissseminate reports and information to developers and managers and I can see some benefit for adding a small webservice. Once we can cache all the information retrieved from Azure locally we can make this available.</p>

<p><a href="http://nancyfx.org">Nancy</a> seems like a great fit for the webservice that will be added.</p>


				
      </section>
	  
      <footer>
        <div class="col">
          <h4>Recent Articles</h4>
          <ol>
              <li><a href="/active-resource-token-auth/">active-resource-token-auth</a> <span>Sep 11</span></li>
              <li><a href="/capistranodeployprocess/">CapistranoDeployProcess</a> <span>Sep  9</span></li>
              <li><a href="/jenkinstobuildruby/">JenkinsToBuildRuby</a> <span>Sep  9</span></li>
              <li><a href="/tdd-with-nsubstitute/">tdd with nsubstitute</a> <span>May  5</span></li>
              <li><a href="/building-with-albacore/">building c# with albacore</a> <span>May  3</span></li>
          </ol>
        </div>
        <div class="col">
          <h4>Tags</h4>
          <ol>
              <li><a href="/tags/ruby/">ruby (4)</a></li>
              <li><a href="/tags/c/">c# (3)</a></li>
              <li><a href="/tags/tdd/">tdd (1)</a></li>
              <li><a href="/tags/continuous-integration/">continuous integration (1)</a></li>
              <li><a href="/tags/jenkins/">jenkins (1)</a></li>
              <li><a href="/tags/unicorn/">unicorn (1)</a></li>
          </ol>
        </div>
        <p>Steve Forkin &mdash; <a href="mailto:steve@netflakes.org">steve@netflakes.org</a></p>
      </footer>
	  
	  
    </div>
    <script src="javascripts/scale.fix.js?1410311636" type="text/javascript"></script>
    
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10920982-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
